apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: '{{ .Release.Namespace }}'

resources:
- default/

patches:
- target:
    kind: Namespace
  patch: |-
    $patch: delete
    apiVersion: v1
    kind: Namespace
    metadata:
      name: capoa-bootstrap-system
- target:
    version: v1
    kind: Deployment
    name: capoa-bootstrap-controller-manager
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: '{{ .Values.bootstrap.image.url  }}:{{ .Values.bootstrap.image.tag  }}'
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ASSISTED_CA_BUNDLE_NAME
        value: assisted-installer-ca
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ASSISTED_CA_BUNDLE_NAMESPACE
        value: '{{ .Release.Namespace }}'
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ASSISTED_CA_BUNDLE_RESOURCE
        value: "secret"
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: ASSISTED_CA_BUNDLE_KEY
        value: "ca.crt"
- target:
    version: v1
    kind: ValidatingWebhookConfiguration
    name: capoa-bootstrap-validating-webhook-configuration
  patch: |-
    - op: replace
      path: /metadata/annotations/cert-manager.io~1inject-ca-from
      value: "{{ .Release.Namespace }}/capoa-bootstrap-cert"
    - op: replace
      path: /webhooks/0/clientConfig/service/namespace
      value: "{{ .Release.Namespace }}"
- target:
    version: v1
    kind: Certificate
    name: capoa-bootstrap-cert
  patch: |-
    - op: replace
      path: /spec/commonName
      value: "capoa-bootstrap-webhook-service.{{ .Release.Namespace }}.svc"
    - op: replace
      path: /spec/dnsNames/0
      value: "capoa-bootstrap-webhook-service.{{ .Release.Namespace }}.svc"
- target:
    version: v1
    kind: ClusterRoleBinding
    name: capoa-bootstrap-manager-rolebinding
  patch: |-
    - op: replace
      path: /subjects/0/namespace
      value: '{{ .Release.Namespace }}'
