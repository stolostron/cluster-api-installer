apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- default/

## Patch the default resources with OCP downstream requirements.
patches:
  # Remove cert-manager annotation and add OCP cert service annotation
  - target:
      version: v1
      kind: CustomResourceDefinition
      annotationSelector: "cert-manager.io/inject-ca-from"
    patch: |-
      - op: remove
        path: /metadata/annotations/cert-manager.io~1inject-ca-from
      - op: add
        path: /metadata/annotations/service.beta.openshift.io~1inject-cabundle
        value: true
  - target:
      version: v1
      kind: MutatingWebhookConfiguration
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.openshift.io~1inject-cabundle
        value: true
      - op: remove
        path: /metadata/annotations/cert-manager.io~1inject-ca-from
  - target:
      version: v1
      kind: ValidatingWebhookConfiguration
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.openshift.io~1inject-cabundle
        value: true
      - op: remove
        path: /metadata/annotations/cert-manager.io~1inject-ca-from
  - target:
      version: v1
      kind: Service
      name: capm3-webhook-service
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.openshift.io~1serving-cert-secret-name
        value: capm3-webhook-service-cert
  - target:
      version: v1
      kind: Service
      name: ipam-webhook-service
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.openshift.io~1serving-cert-secret-name
        value: ipam-webhook-service-cert
