---
apiVersion: controlplane.cluster.x-k8s.io/v1beta2
kind: AROControlPlane
metadata:
 name: ${CS_CLUSTER_NAME}
 namespace: ${NAMESPACE}
spec:
 platform:
   resourceGroup: ${RESOURCEGROUPNAME}
   keyVault: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${RESOURCEGROUPNAME}/providers/Microsoft.KeyVault/vaults/${KV}"
 subscriptionID: "${AZURE_SUBSCRIPTION_ID}"
 identityRef:
    kind: AzureClusterIdentity
    name: ${AZURE_CLUSTER_IDENTITY_NAME}
    namespace: ${AZURE_CLUSTER_IDENTITY_NAMESPACE}
 resources:
   - apiVersion: redhatopenshift.azure.com/v1api20240610preview
     kind: HcpOpenShiftCluster
     metadata:
       name: ${CS_CLUSTER_NAME}
       namespace: ${NAMESPACE}
     spec:
       azureName: ${CS_CLUSTER_NAME}
       location: ${REGION}
       owner:
         name: ${RESOURCEGROUPNAME}
       operatorSpec:
         secrets:
          adminCredentials:
            name: ${CS_CLUSTER_NAME}-kubeconfig
            key: value
       identity: 
         type: UserAssigned
         userAssignedIdentities:
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}"
             - reference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}"
       properties:
         platform:
           networkSecurityGroupReference:
             group: network.azure.com
             kind: NetworkSecurityGroup
             name: ${NSG}
           operatorsAuthentication:
             userAssignedIdentities:
               controlPlaneOperatorsReferences:
                 cloud-controller-manager:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}"
                 cloud-network-config:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}"
                 cluster-api-azure:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}"
                 control-plane:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}"
                 disk-csi-driver:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}"
                 file-csi-driver:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}"
                 image-registry:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}"
                 ingress:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}"
                 kms:
                   armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}"
               dataPlaneOperatorsReferences:
                disk-csi-driver:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}"
                file-csi-driver:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}"
                image-registry:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}"
               serviceManagedIdentityReference:
                 armId: "/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourcegroups/${RESOURCEGROUPNAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}"
           subnetReference:
             group: network.azure.com
             kind: VirtualNetworksSubnet
             name: "${VNET}-${SUBNET}"
           managedResourceGroup: "capz_node_${CS_CLUSTER_NAME}_${RESOURCEGROUPNAME}_rg"
           outboundType: LoadBalancer
         clusterImageRegistry:
           state: Enabled
         etcd:
           dataEncryption:
             keyManagementMode: CustomerManaged
             customerManaged:
               encryptionType: KMS
               kms:
                 activeKey:
                   vaultName: "${KV}"
                   name: "etcd-data-kms-encryption-key"
         network:
           hostPrefix: 23
           networkType: OVNKubernetes
           machineCidr: "10.0.0.0/16"
           podCidr: "10.128.0.0/14"
           serviceCidr: "172.30.0.0/16"
         version:
           channelGroup: stable
           id: "${OCP_VERSION}"
         api:
           visibility: Public
       tags:
         environment: production
         owner: sre-team
${EA_DISABLE}   # External Authentication Configuration
${EA_DISABLE}   # IMPORTANT: Replace the values below with your actual OIDC provider details
${EA_DISABLE}   - apiVersion: redhatopenshift.azure.com/v1api20240610preview
${EA_DISABLE}     kind: HcpOpenShiftClustersExternalAuth
${EA_DISABLE}     metadata:
${EA_DISABLE}       name: ${EA_OIDC_PROVIDER_NAME}
${EA_DISABLE}       namespace: ${NAMESPACE}
${EA_DISABLE}     spec:
${EA_DISABLE}       azureName: ${EA_OIDC_PROVIDER_NAME}
${EA_DISABLE}       owner:
${EA_DISABLE}         name: ${CS_CLUSTER_NAME}
${EA_DISABLE}       properties:
${EA_DISABLE}         issuer:
${EA_DISABLE}           url: "https://login.microsoftonline.com/${EA_AZURE_TENANT_ID}/v2.0"
${EA_DISABLE}           audiences:
${EA_DISABLE}             - "${EA_AZURE_CLIENT_ID}"
${EA_DISABLE}         claim:
${EA_DISABLE}           mappings:
${EA_DISABLE}             username:
${EA_DISABLE}               claim: "${EA_OIDC_USERNAME_CLAIM}"
${EA_DISABLE}               prefixPolicy: "NoPrefix"
${EA_DISABLE}             groups:
${EA_DISABLE}               claim: "${EA_OIDC_GROUPS_CLAIM}"
${EA_DISABLE}         clients:
${EA_DISABLE}           - clientId: "${EA_AZURE_CLIENT_ID}"
${EA_DISABLE}             component:
${EA_DISABLE}               name: "console"
${EA_DISABLE}               authClientNamespace: "openshift-console"
${EA_DISABLE}             type: "Confidential"
${EA_DISABLE}             extraScopes:
${EA_DISABLE}               - "openid"
${EA_DISABLE}               - "profile"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AROMachinePool
metadata:
 name: ${CS_CLUSTER_NAME}-mp1
 namespace: ${NAMESPACE}
spec:
  resources:
    - apiVersion: redhatopenshift.azure.com/v1api20240610preview
      kind: HcpOpenShiftClustersNodePool
      metadata:
        name: ${CS_CLUSTER_NAME}-mp1
        namespace: ${NAMESPACE}
      spec:
        azureName: ${CS_CLUSTER_NAME}-mp1
        location: ${REGION}
        owner:
          name: ${CS_CLUSTER_NAME}
        properties:
          # replicas: 2
          autoRepair: true
          autoScaling:
            min: 2
            max: 10
          labels:
            - key: region
              value: ${REGION}
          # taints:
          #   - key: "example.com/special"
          #     value: "true"
          #     effect: "NoSchedule"
          platform:
            osDisk:
              diskStorageAccountType: "Standard_LRS"
              sizeGiB: 128
            subnetReference:
              group: network.azure.com
              kind: VirtualNetworksSubnet
              name: "${VNET}-${SUBNET}"
            vmSize: "Standard_D4s_v3"
          version:
            channelGroup: stable
            id: "${OCP_VERSION_MP}"
        tags:
          environment: production
          cost-center: engineering
---
apiVersion: cluster.x-k8s.io/v1beta2
kind: MachinePool
metadata:
  name: ${CS_CLUSTER_NAME}-mp1
  namespace: ${NAMESPACE}
  labels:
    cluster.x-k8s.io/cluster-name: ${CS_CLUSTER_NAME}
spec:
  replicas: 2
  clusterName: ${CS_CLUSTER_NAME}
  template:
    spec:
      bootstrap:
        dataSecretName: ${CS_CLUSTER_NAME}-kubeconfig
      clusterName: ${CS_CLUSTER_NAME}
      infrastructureRef:
        apiGroup: infrastructure.cluster.x-k8s.io
        kind: AROMachinePool
        name: ${CS_CLUSTER_NAME}-mp1
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AROCluster
metadata:
 name: ${CS_CLUSTER_NAME}
 namespace: ${NAMESPACE}
 labels:
   cluster.x-k8s.io/cluster-name: ${CS_CLUSTER_NAME}
spec:
  resources:
  # Equivalent to:
  # az group create --name "${RESOURCEGROUPNAME}" --location "${REGION}"
  # This YAML creates a Resource Group named "${RESOURCEGROUPNAME}" in the specified Azure region "${REGION}".
  - apiVersion: resources.azure.com/v1api20200601
    kind: ResourceGroup
    metadata:
      name: ${RESOURCEGROUPNAME}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
  # Equivalent to:
  # az network vnet create -n "${VNET}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a virtual network named "${VNET}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: network.azure.com/v1api20201101
    kind: VirtualNetwork
    metadata:
      name: ${VNET}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      addressSpace:
        addressPrefixes:
          - 10.100.0.0/15
  # Equivalent to:
  # az network nsg create -n "${NSG}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a Network Security Group (NSG) named "${NSG}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: network.azure.com/v1api20201101
    kind: NetworkSecurityGroup
    metadata:
      name: ${NSG}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
  # Equivalent to:
  # az network vnet subnet create -n "${SUBNET}" -g "${RESOURCEGROUPNAME}" --vnet-name "${VNET}" --network-security-group "${NSG}"
  # This YAML creates a subnet named "${SUBNET}" in the "${VNET}" virtual network and associates it with the "${NSG}" Network Security Group.
  - apiVersion: network.azure.com/v1api20201101
    kind: VirtualNetworksSubnet
    metadata:
      name: ${VNET}-${SUBNET}
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}
      addressPrefix: 10.100.76.0/24
      azureName: ${SUBNET}
      networkSecurityGroup:
        reference:
          name: ${NSG}
          group: network.azure.com
          kind: NetworkSecurityGroup
  # Equivalent to:
  # az keyvault create --name "$KV" -g ${RESOURCEGROUPNAME} --location "${REGION}" --enable-rbac-authorization true
  # This YAML creates a key vault named "${KV}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: keyvault.azure.com/v1api20230701
    kind: Vault
    metadata:
      name: "${KV}"
      namespace: ${NAMESPACE}
    spec:
      location: "${REGION}"
      owner:
        name: "${RESOURCEGROUPNAME}"
      properties:
        createMode: createOrRecover
        enableRbacAuthorization: true
        enabledForDiskEncryption: false
        enabledForTemplateDeployment: false
        enableSoftDelete: true
        tenantId: "${AZURE_TENANT_ID}"
        accessPolicies: [] 
        sku:
          family: A
          name: standard
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  # Equivalent to:
  # az identity create -n "${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}" -g "${RESOURCEGROUPNAME}"
  # This YAML creates a managed identity named "${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}" in the "${RESOURCEGROUPNAME}" resource group.
  - apiVersion: managedidentity.azure.com/v1api20230131
    kind: UserAssignedIdentity
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
      namespace: ${NAMESPACE}
    spec:
      location: ${REGION}
      owner:
        name: ${RESOURCEGROUPNAME}
      operatorSpec:
        configMaps:
          principalId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
            key: principalId
          clientId:
            name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
            key: clientId
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}-hcpclusterapiproviderroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 88366f10-ed47-4cc0-9fab-c8a06148393e represents 'hcpClusterApiProviderRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/88366f10-ed47-4cc0-9fab-c8a06148393e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-clusterapiazuremi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-cluster-api-azure-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}-keyvaultcryptouserroleid-keyvault
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${KV}
        group: keyvault.azure.com
        kind: Vault
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 12338af0-0e69-4776-bea7-57ae8d297424 represents 'keyVaultCryptoUserRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/12338af0-0e69-4776-bea7-57ae8d297424
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-kmsmi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-kms-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}-hcpcontrolplaneoperatorroleid-vnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}
        group: network.azure.com
        kind: VirtualNetwork
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # fc0c873f-45e9-4d0d-a7d1-585aab30c6ed represents 'hcpControlPlaneOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/fc0c873f-45e9-4d0d-a7d1-585aab30c6ed
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}-hcpcontrolplaneoperatorroleid-nsg
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${NSG}
        group: network.azure.com
        kind: NetworkSecurityGroup
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # fc0c873f-45e9-4d0d-a7d1-585aab30c6ed represents 'hcpControlPlaneOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/fc0c873f-45e9-4d0d-a7d1-585aab30c6ed
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-controlplanemi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-control-plane-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}-cloudcontrollermanagerroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # a1f96423-95ce-4224-ab27-4e3dc72facd4 represents 'cloudControllerManagerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/a1f96423-95ce-4224-ab27-4e3dc72facd4
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}-cloudcontrollermanagerroleid-nsg
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${NSG}
        group: network.azure.com
        kind: NetworkSecurityGroup
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # a1f96423-95ce-4224-ab27-4e3dc72facd4 represents 'cloudControllerManagerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/a1f96423-95ce-4224-ab27-4e3dc72facd4
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-cloudcontrollermanagermi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-controller-manager-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}-ingressoperatorroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 0336e1d3-7a87-462b-b6db-342b63f7802c represents 'ingressOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/0336e1d3-7a87-462b-b6db-342b63f7802c
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-ingressmi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-ingress-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-diskcsidrivermi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}-filestorageoperatorroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 0d7aedc0-15fd-4a67-a412-efad370c947e represents 'fileStorageOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/0d7aedc0-15fd-4a67-a412-efad370c947e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}-filestorageoperatorroleid-nsg
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${NSG}
        group: network.azure.com
        kind: NetworkSecurityGroup
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 0d7aedc0-15fd-4a67-a412-efad370c947e represents 'fileStorageOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/0d7aedc0-15fd-4a67-a412-efad370c947e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-filecsidrivermi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-imageregistrymi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-image-registry-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}-networkoperatorroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # be7a6435-15ae-4171-8f30-4a343eff9e8f represents 'networkOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/be7a6435-15ae-4171-8f30-4a343eff9e8f
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}-networkoperatorroleid-vnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}
        group: network.azure.com
        kind: VirtualNetwork
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # be7a6435-15ae-4171-8f30-4a343eff9e8f represents 'networkOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/be7a6435-15ae-4171-8f30-4a343eff9e8f
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-readerroleid-cloudnetworkconfigmi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-cp-cloud-network-config-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # acdd72a7-3385-48ef-bd42-f606fba81ae7 represents 'readerRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-federatedcredentialsroleid-dpdiskcsidrivermi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-dp-disk-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # ef318e2a-8334-4a05-9e4a-295a196c6a6e represents 'federatedCredentialsRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/ef318e2a-8334-4a05-9e4a-295a196c6a6e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-federatedcredentialsroleid-dpfilecsidrivermi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # ef318e2a-8334-4a05-9e4a-295a196c6a6e represents 'federatedCredentialsRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/ef318e2a-8334-4a05-9e4a-295a196c6a6e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}-filestorageoperatorroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 0d7aedc0-15fd-4a67-a412-efad370c947e represents 'fileStorageOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/0d7aedc0-15fd-4a67-a412-efad370c947e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}-filestorageoperatorroleid-nsg
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${NSG}
        group: network.azure.com
        kind: NetworkSecurityGroup
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-dp-file-csi-driver-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # 0d7aedc0-15fd-4a67-a412-efad370c947e represents 'fileStorageOperatorRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/0d7aedc0-15fd-4a67-a412-efad370c947e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-federatedcredentialsroleid-dpimageregistrymi
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${USER}-${CS_CLUSTER_NAME}-dp-image-registry-${OPERATORS_UAMIS_SUFFIX}
        group: managedidentity.azure.com
        kind: UserAssignedIdentity
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # ef318e2a-8334-4a05-9e4a-295a196c6a6e represents 'federatedCredentialsRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/ef318e2a-8334-4a05-9e4a-295a196c6a6e
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-hcpservicemanagedidentityroleid-vnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}
        group: network.azure.com
        kind: VirtualNetwork
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # c0ff367d-66d8-445e-917c-583feb0ef0d4 represents 'hcpServiceManagedIdentityRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/c0ff367d-66d8-445e-917c-583feb0ef0d4
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-hcpservicemanagedidentityroleid-subnet
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${VNET}-${SUBNET}
        group: network.azure.com
        kind: VirtualNetworksSubnet
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # c0ff367d-66d8-445e-917c-583feb0ef0d4 represents 'hcpServiceManagedIdentityRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/c0ff367d-66d8-445e-917c-583feb0ef0d4
  - apiVersion: authorization.azure.com/v1api20220401
    kind: RoleAssignment
    metadata:
      name: ${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}-hcpservicemanagedidentityroleid-nsg
      namespace: ${NAMESPACE}
    spec:
      owner:
        name: ${NSG}
        group: network.azure.com
        kind: NetworkSecurityGroup
      principalIdFromConfig:
        name: identity-map-${USER}-${CS_CLUSTER_NAME}-service-managed-identity-${OPERATORS_UAMIS_SUFFIX}
        key: principalId
      principalType: ServicePrincipal
      roleDefinitionReference:
        # c0ff367d-66d8-445e-917c-583feb0ef0d4 represents 'hcpServiceManagedIdentityRoleId'
        armId: /subscriptions/${AZURE_SUBSCRIPTION_ID}/providers/Microsoft.Authorization/roleDefinitions/c0ff367d-66d8-445e-917c-583feb0ef0d4
---
apiVersion: cluster.x-k8s.io/v1beta2
kind: Cluster
metadata:
  name: ${CS_CLUSTER_NAME}
  namespace: ${NAMESPACE}
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  controlPlaneRef:
    apiGroup: controlplane.cluster.x-k8s.io
    kind: AROControlPlane
    name: ${CS_CLUSTER_NAME}
  infrastructureRef:
    apiGroup: infrastructure.cluster.x-k8s.io
    kind: AROCluster
    name: ${CS_CLUSTER_NAME}
---
